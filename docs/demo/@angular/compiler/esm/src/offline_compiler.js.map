{"version":3,"file":"offline_compiler.js","sourceRoot":"","sources":["../../../../../modules/@angular/compiler/src/offline_compiler.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright Google Inc. All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\nimport {ComponentFactory} from '@angular/core';\n\nimport {CompileDirectiveMetadata, CompileIdentifierMetadata, CompilePipeMetadata, createHostComponentMeta} from './compile_metadata';\nimport {DirectiveNormalizer} from './directive_normalizer';\nimport {ListWrapper} from './facade/collection';\nimport {BaseException} from './facade/exceptions';\nimport {OutputEmitter} from './output/abstract_emitter';\nimport * as o from './output/output_ast';\nimport {CompiledStylesheet, StyleCompiler} from './style_compiler';\nimport {TemplateParser} from './template_parser';\nimport {assetUrl} from './util';\nimport {ComponentFactoryDependency, ViewCompileResult, ViewCompiler, ViewFactoryDependency} from './view_compiler/view_compiler';\nimport {XHR} from './xhr';\n\nvar _COMPONENT_FACTORY_IDENTIFIER = new CompileIdentifierMetadata({\n  name: 'ComponentFactory',\n  runtime: ComponentFactory,\n  moduleUrl: assetUrl('core', 'linker/component_factory')\n});\n\nexport class SourceModule {\n  constructor(public moduleUrl: string, public source: string) {}\n}\n\nexport class StyleSheetSourceWithImports {\n  constructor(public source: SourceModule, public importedUrls: string[]) {}\n}\n\nexport class NormalizedComponentWithViewDirectives {\n  constructor(\n      public component: CompileDirectiveMetadata, public directives: CompileDirectiveMetadata[],\n      public pipes: CompilePipeMetadata[]) {}\n}\n\nexport class OfflineCompiler {\n  constructor(\n      private _directiveNormalizer: DirectiveNormalizer, private _templateParser: TemplateParser,\n      private _styleCompiler: StyleCompiler, private _viewCompiler: ViewCompiler,\n      private _outputEmitter: OutputEmitter) {}\n\n  normalizeDirectiveMetadata(directive: CompileDirectiveMetadata):\n      Promise<CompileDirectiveMetadata> {\n    return this._directiveNormalizer.normalizeDirective(directive).asyncResult;\n  }\n\n  compileTemplates(components: NormalizedComponentWithViewDirectives[]): SourceModule[] {\n    if (components.length === 0) {\n      throw new BaseException('No components given');\n    }\n    var statements: o.DeclareVarStmt[] = [];\n    var exportedVars: string[] = [];\n    var moduleUrl = _ngfactoryModuleUrl(components[0].component.type);\n    var outputSourceModules: SourceModule[] = [];\n    components.forEach(componentWithDirs => {\n      var compMeta = <CompileDirectiveMetadata>componentWithDirs.component;\n      _assertComponent(compMeta);\n      var fileSuffix = _splitLastSuffix(compMeta.type.moduleUrl)[1];\n      var stylesCompileResults = this._styleCompiler.compileComponent(compMeta);\n      stylesCompileResults.externalStylesheets.forEach((compiledStyleSheet) => {\n        outputSourceModules.push(this._codgenStyles(compiledStyleSheet, fileSuffix));\n      });\n\n      var compViewFactoryVar = this._compileComponent(\n          compMeta, componentWithDirs.directives, componentWithDirs.pipes,\n          stylesCompileResults.componentStylesheet, fileSuffix, statements);\n      exportedVars.push(compViewFactoryVar);\n\n      var hostMeta = createHostComponentMeta(compMeta.type, compMeta.selector);\n      var hostViewFactoryVar =\n          this._compileComponent(hostMeta, [compMeta], [], null, fileSuffix, statements);\n      var compFactoryVar = _componentFactoryName(compMeta.type);\n      statements.push(\n          o.variable(compFactoryVar)\n              .set(o.importExpr(_COMPONENT_FACTORY_IDENTIFIER, [o.importType(compMeta.type)])\n                       .instantiate(\n                           [\n                             o.literal(compMeta.selector), o.variable(hostViewFactoryVar),\n                             o.importExpr(compMeta.type)\n                           ],\n                           o.importType(\n                               _COMPONENT_FACTORY_IDENTIFIER, [o.importType(compMeta.type)],\n                               [o.TypeModifier.Const])))\n              .toDeclStmt(null, [o.StmtModifier.Final]));\n      exportedVars.push(compFactoryVar);\n    });\n    outputSourceModules.unshift(this._codegenSourceModule(moduleUrl, statements, exportedVars));\n    return outputSourceModules;\n  }\n\n  private _compileComponent(\n      compMeta: CompileDirectiveMetadata, directives: CompileDirectiveMetadata[],\n      pipes: CompilePipeMetadata[], componentStyles: CompiledStylesheet, fileSuffix: string,\n      targetStatements: o.Statement[]): string {\n    var parsedTemplate = this._templateParser.parse(\n        compMeta, compMeta.template.template, directives, pipes, compMeta.type.name);\n    var stylesExpr = componentStyles ? o.variable(componentStyles.stylesVar) : o.literalArr([]);\n    var viewResult =\n        this._viewCompiler.compileComponent(compMeta, parsedTemplate, stylesExpr, pipes);\n    if (componentStyles) {\n      ListWrapper.addAll(targetStatements, _resolveStyleStatements(componentStyles, fileSuffix));\n    }\n    ListWrapper.addAll(targetStatements, _resolveViewStatements(viewResult));\n    return viewResult.viewFactoryVar;\n  }\n\n  private _codgenStyles(stylesCompileResult: CompiledStylesheet, fileSuffix: string): SourceModule {\n    _resolveStyleStatements(stylesCompileResult, fileSuffix);\n    return this._codegenSourceModule(\n        _stylesModuleUrl(\n            stylesCompileResult.meta.moduleUrl, stylesCompileResult.isShimmed, fileSuffix),\n        stylesCompileResult.statements, [stylesCompileResult.stylesVar]);\n  }\n\n  private _codegenSourceModule(\n      moduleUrl: string, statements: o.Statement[], exportedVars: string[]): SourceModule {\n    return new SourceModule(\n        moduleUrl, this._outputEmitter.emitStatements(moduleUrl, statements, exportedVars));\n  }\n}\n\nfunction _resolveViewStatements(compileResult: ViewCompileResult): o.Statement[] {\n  compileResult.dependencies.forEach((dep) => {\n    if (dep instanceof ViewFactoryDependency) {\n      let vfd = <ViewFactoryDependency>dep;\n      vfd.placeholder.moduleUrl = _ngfactoryModuleUrl(vfd.comp);\n    } else if (dep instanceof ComponentFactoryDependency) {\n      let cfd = <ComponentFactoryDependency>dep;\n      cfd.placeholder.name = _componentFactoryName(cfd.comp);\n      cfd.placeholder.moduleUrl = _ngfactoryModuleUrl(cfd.comp);\n    }\n  });\n  return compileResult.statements;\n}\n\n\nfunction _resolveStyleStatements(\n    compileResult: CompiledStylesheet, fileSuffix: string): o.Statement[] {\n  compileResult.dependencies.forEach((dep) => {\n    dep.valuePlaceholder.moduleUrl = _stylesModuleUrl(dep.moduleUrl, dep.isShimmed, fileSuffix);\n  });\n  return compileResult.statements;\n}\n\nfunction _ngfactoryModuleUrl(comp: CompileIdentifierMetadata): string {\n  var urlWithSuffix = _splitLastSuffix(comp.moduleUrl);\n  return `${urlWithSuffix[0]}.ngfactory${urlWithSuffix[1]}`;\n}\n\nfunction _componentFactoryName(comp: CompileIdentifierMetadata): string {\n  return `${comp.name}NgFactory`;\n}\n\nfunction _stylesModuleUrl(stylesheetUrl: string, shim: boolean, suffix: string): string {\n  return shim ? `${stylesheetUrl}.shim${suffix}` : `${stylesheetUrl}${suffix}`;\n}\n\nfunction _assertComponent(meta: CompileDirectiveMetadata) {\n  if (!meta.isComponent) {\n    throw new BaseException(`Could not compile '${meta.type.name}' because it is not a component.`);\n  }\n}\n\nfunction _splitLastSuffix(path: string): string[] {\n  let lastDot = path.lastIndexOf('.');\n  if (lastDot !== -1) {\n    return [path.substring(0, lastDot), path.substring(lastDot)];\n  } else {\n    return [path, ''];\n  }\n}\n\ninterface DecoratorInvocation {\n  type: Function;\n  args?: any[];\n}\n"]}