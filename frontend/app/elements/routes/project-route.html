<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../components/project-link.html">
<link rel="import" href="../components/project-endpoint.html">
<link rel="import" href="../components/json-preview.html">
<link rel="import" href="../components/model-element.html">


<dom-module id="project-route">
    <template>
        <style include="shared-styles">

            :host ::content h4 {
                position: relative;
            }

            :host ::content .client-title {
                margin-bottom: 5px;
                margin-top: 10px;
            }

            :host ::content .client-title project-link {
                display: inline-block;
            }

            :host ::content .client-title .note {
                font-size: 12px;
                color: #F44336;
            }

            :host ::content .errors {
                color: #F44336;
                font-size: 14px;
            }
        </style>
        <template is="dom-if" if="{{!_empty(project.links)}}">
            <h3>Links</h3>
            <paper-material elevation="1">
                <template is="dom-repeat" items="{{project.links}}" as="link">
                    <project-link settings="{{settings}}" href="{{link.href}}" rel="{{link.rel}}" target="_blank"></project-link>
                </template>
            </paper-material>
        </template>
        <template is="dom-if" if="{{!_empty(project.endpoints)}}">
            <h3>Endpoints</h3>
            <template is="dom-repeat" items="{{project.endpoints}}" as="endpoint">
                <project-endpoint settings="{{settings}}" endpoint="{{endpoint}}" project="{{project}}"></project-endpoint>
            </template>
        </template>
        <template is="dom-if" if="{{!_empty(project.clients)}}">
            <h3>Clients</h3>
            <template is="dom-repeat" items="{{project.clients}}" as="client">
                <div class="client-title">
                    <project-link settings="{{settings}}" href="{{_getProjectLink(client)}}" rel="{{client.name}}" no-target="true"></project-link>
                    <template is="dom-if" if="{{_isClientNotLatest(client)}}">
                        <span class="note">
                            (current:
                            <span hidden$="{{_empty(client.version)}}">unsupported</span><project-link hidden$="{{!_empty(client.version)}}" settings="{{settings}}" href="{{_getProjectLink(client, client.version)}}" rel="{{client.version}}" prefix="false" no-target="{{true}}">
                            </project-link>, latest:
                            <project-link settings="{{settings}}" href="{{_getProjectLink(client, client.latestVersion)}}" rel="{{client.latestVersion}}" prefix="false" no-target="true"></project-link>)
                        </span>
                    </template>
                </div>
                <ul class="errors">
                    <template is="dom-repeat" items="{{client.errors}}" as="error">
                        <li>{{error}}</li>
                    </template>
                </ul>
                <template is="dom-repeat" items="{{client.endpoints}}" as="endpoint">
                    <project-endpoint settings="{{settings}}" endpoint="{{endpoint}}" project="{{project}}"></project-endpoint>
                </template>
            </template>
        </template>

        <template is="dom-if" if="{{!_empty(modelNames)}}">
            <h3>Models</h3>
            <template is="dom-repeat" items="{{modelNames}}" as="name">
                <template is="dom-if" if="{{_isProjectModel(name)}}">
                    <model-element model="{{_getModel(name)}}" project="{{project}}" settings="{{settings}}"></model-element>
                </template>
            </template>
        </template>
    </template>
    <script>
        Polymer({
            is: 'project-route',

            properties: {
                project: {
                    type: Object
                },
                settings: Object,

                modelNames: {
                    computed: '_computeModelNames(project)'
                }
            },

            _computeModelNames: function (project) {
                var modelNames = [];
                if (!this._empty(this.project) && !this._empty(this.project.models)) {
                    modelNames = Object.keys(this.project.models);
                }
                return modelNames;
            },

            _getModel: function (name) {
                if (!this._empty(this.project) && !this._empty(this.project.models)) {
                    return this.project.models[name];
                }
                return null;
            },

            _getModelName: function (name) {
                return this.project.models[name].classType.simpleName;
            },

            _isProjectModel: function (name) {
                var model = this._getModel(name);
                if (!this._empty(model)) {
                    return model.classType.name.indexOf(this.settings.links.package) == 0;
                }
            },

            _isClientNotLatest: function (client) {
                if(this._empty(client.latestVersion)){
                    console.info(client.latestVersion);
                    return false;
                }
                return client.latestVersion != client.version;
            },

            _getClientVersion: function (client) {
                return client.version != null ? client.version : "unsupported";
            },

            _getProjectLink: function (client, version) {
                var url = this.settings.baseUrl + client.group + "/" + client.name;
                if (!this._empty(version)) {
                    url += "/" + version;
                }
                return url;
            },

            _empty: function (obj) {
                if (obj == undefined || obj == null) {
                    return true;
                }
                if (obj.length != undefined && obj.length == 0) {
                    return true;
                }
                return false;
            }

        });
    </script>
</dom-module>
