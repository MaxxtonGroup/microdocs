<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../components/project-link.html">
<link rel="import" href="../components/project-endpoint.html">
<link rel="import" href="../components/json-preview.html">
<link rel="import" href="../components/model-element.html">


<dom-module id="project-route">
    <template>
        <style include="shared-styles">

            :host ::content h4 {
                position: relative;
            }

            :host ::content .client-title {
                margin-bottom: 5px;
                margin-top: 10px;
            }

            :host ::content .client-title project-link {
                display: inline-block;
            }

            :host ::content .client-title .note {
                font-size: 12px;
                color: #F44336;
            }

            :host ::content .errors {
                background-color: rgba(244, 67, 54, 0.6);
                padding: 10px 20px;
                border-radius: 5px;
                color: white;
            }

            :host ::content ul.errors {
                padding-left: 40px;
            }

            :host ::content .warning{
                background-color: rgba(255,152,0,0.6);
                padding: 10px 20px;
                border-radius: 5px;
                color: #FFFFFF;
            }

            :host ::content .container {
                opacity: 1;
                transition: 0.2s ease opacity;
            }

            :host ::content .container.hidden {
                opacity: 0;
            }
        </style>
        <template is="dom-if" if="{{project.loadError}}">
            <div class="error">
                <iron-icon icon="error"></iron-icon>
                <span>Oepss... Something went wrong</span>
            </div>
        </template>
        <template is="dom-if" if="{{project.cleaned}}">
            <div class="warning">
                <iron-icon icon="warning"></iron-icon>
                <span>This version is cleaned up</span>
            </div>
        </template>
        <div class$="{{_getHiddenClass(project)}}">
            <div class="errors" hidden$="{{_zero(project.errors)}}">
                <iron-icon icon="error"></iron-icon>
                <span>This project contains {{project.errors}} errors</span>
            </div>
            <template is="dom-if" if="{{!_empty(project.links)}}">
                <h3>Links</h3>
                <paper-material elevation="1">
                    <template is="dom-repeat" items="{{project.links}}" as="link">
                        <project-link settings="{{settings}}" href="{{link.href}}" rel="{{link.rel}}" target="_blank"></project-link>
                    </template>
                </paper-material>
            </template>
            <template is="dom-if" if="{{!_empty(project.endpoints)}}">
                <h3>Endpoints</h3>
                <template is="dom-repeat" items="{{project.endpoints}}" as="endpoint" sort="_sortEndpoints">
                    <project-endpoint settings="{{settings}}" endpoint="{{endpoint}}" project="{{project}}"></project-endpoint>
                </template>
            </template>
            <template is="dom-if" if="{{!_empty(project.clients)}}">
                <h3>Clients</h3>
                <template is="dom-repeat" items="{{project.clients}}" as="client" sort="_sortClients">
                    <div class="client-title">
                        <project-link settings="{{settings}}" href="{{_getProjectLink(client)}}" rel="{{client.name}}" no-target="true"></project-link>
                        <template is="dom-if" if="{{_isClientNotLatest(client)}}">
                        <span class="note">
                            (supported:
                            <span hidden$="{{!_empty(client.version)}}">unsupported</span><project-link hidden$="{{_empty(client.version)}}" settings="{{settings}}" href="{{_getProjectLink(client, client.version)}}" rel="{{client.version}}" prefix="false" no-target="true">
                            </project-link>, latest:
                            <project-link settings="{{settings}}" href="{{_getProjectLink(client, client.latestVersion)}}" rel="{{client.latestVersion}}" prefix="false" no-target="true"></project-link>)
                        </span>
                        </template>
                    </div>
                    <ul class="errors" hidden$="{{_empty(client.errors)}}">
                        <template is="dom-repeat" items="{{client.errors}}" as="error">
                            <li>{{error}}</li>
                        </template>
                    </ul>
                    <template is="dom-repeat" items="{{client.endpoints}}" as="endpoint" sort="_sortEndpoints">
                        <project-endpoint settings="{{settings}}" endpoint="{{endpoint}}" project="{{project}}"></project-endpoint>
                    </template>
                </template>
            </template>

            <template is="dom-if" if="{{!_empty(modelNames)}}">
                <h3>Models</h3>
                <template is="dom-repeat" items="{{modelNames}}" as="name" sort="_sortModels">
                    <template is="dom-if" if="{{_isProjectModel(name)}}">
                        <model-element model="{{_getModel(name)}}" project="{{project}}" settings="{{settings}}"></model-element>
                    </template>
                </template>
            </template>
        </div>
    </template>
    <script>
        Polymer({
            is: 'project-route',

            properties: {
                project: {
                    type: Object
                },
                settings: Object,

                modelNames: {
                    computed: '_computeModelNames(project)'
                }
            },

            _computeModelNames: function (project) {
                var modelNames = [];
                if (!this._empty(this.project) && !this._empty(this.project.models)) {
                    modelNames = Object.keys(this.project.models);
                }
                return modelNames;
            },

            _getModel: function (name) {
                if (!this._empty(this.project) && !this._empty(this.project.models)) {
                    return this.project.models[name];
                }
                return null;
            },

            _getModelName: function (name) {
                return this.project.models[name].classType.simpleName;
            },

            _isProjectModel: function (name) {
                var model = this._getModel(name);
                if (!this._empty(model)) {
                    return model.classType.name.indexOf(this.settings.links.package) == 0;
                }
            },

            _isClientNotLatest: function (client) {
                if (this._empty(client.latestVersion)) {
                    return false;
                }
                return client.latestVersion != client.version;
            },

            _getClientVersion: function (client) {
                return client.version != null ? client.version : "unsupported";
            },

            _getProjectLink: function (client, version) {
                var url = this.settings.baseUrl + client.group + "/" + client.name;
                if (!this._empty(version)) {
                    url += "/" + version;
                }
                return url;
            },

            _empty: function (obj) {
                if (obj == undefined || obj == null) {
                    return true;
                }
                if (obj.length != undefined && obj.length == 0) {
                    return true;
                }
                return false;
            },

            _sortEndpoints: function (a, b) {
                if (a.path === b.path) return 0;
                return a.path < b.path ? -1 : 1;
            },

            _sortClients: function (a, b) {
                if (a.name === b.name) return 0;
                return a.name < b.name ? -1 : 1;
            },

            _sortModels: function (a, b) {
                if (a === b) return 0;
                return a < b ? -1 : 1;
            },

            _zero: function (number) {
                return number == undefined || number == 0;
            },

            _getHiddenClass: function (project) {
                return "container " + (this._empty(project) || !project.loaded ? "hidden" : "");
            }

        });
    </script>
</dom-module>
